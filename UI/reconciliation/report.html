[%
  PROCESS 'elements.html';
  PROCESS 'attachments.html';
-%]
<body class="lsmb [% dojo_theme %]">
<div id="reconciliation">
[% IF check.unapproved_transactions
%]<div class="warning"><a href="drafts.pl?__action=list_drafts&amp;to_date=[% end_date %]">[% text('There are [_1] unapproved transactions before the end date of this report.',check.unapproved_transactions)
%]</a></div>
[% END; IF check.unapproved_reports
%]<div class="warning"><a href="recon.pl?__action=get_results&amp;to_date=[% end_date %]&amp;approved=0">[% text('There are [_1] unapproved reconciliations before the end date of this report.',check.unapproved_reports) %]</a></div>
[% END %]
[% IF ! defined(b_cleared_table);
    b_cleared_table = 'checked';
    END %]
[% IF ! defined(b_cleared_table) or ! defined(b_cleared_table);
    b_mismatch_table = "";
    b_outstanding_table = "";
    IF !approved and !submitted;
        FOREACH row = report_lines;
            IF row.err == 'mismatch';
                b_mismatch_table = 'checked';
            END;
            IF row.cleared != 'checked' and row.err != 'mismatch';
                b_outstanding_table = 'checked';
            END;
        END;
    END;
END %]
<form data-dojo-type="lsmb/Reconciliation" action="recon.pl" method="post" enctype="multipart/form-data">
<div class="listtop" id="title">[% text('Reconciliation Report') %]</div>
<table id="report_headings" class="info">
<tr>
  <th>[% text('Account:') %]</th>
  <td>[% account_info.accno %] [% account_info.description %]</td>
</tr>
<tr>
  <th>[% text('Statement Date') %]:</th><td>[% end_date %]</td>
</tr>
<tr>
  <th>[% text('Beginning Statement Balance:') %]</th>
  <td>[% beginning_balance %]</td>
</tr>
<tr>
  <th>[% text('Ending Statement Balance:') %]</th>
[% IF submitted %]
  <td>[% their_total %]</td>
[% ELSE %]
  <td>[% INCLUDE input element_data = {
    name = "their_total",
    type = "text",
    class = "money",
    size = "15",
    value = their_total
    } %]
  </td>
[% END %]
</tr>
<tr>
[% IF ! approved %]
  <th>[% text('Variance:') %]</th>
  <td>[% variance %]</td>
[% END %]
</tr>
[% IF ! approved %]
<tr>
  <th>[% text('Less Outstanding Checks:') %]</th>
  <td>[% outstanding_total %]</td>
</tr>
<tr>
  <th>[% text('Ending GL Balance:') %]</th>
  <td>[% statement_gl_calc %]</td>
</tr>
[% END %]
<tr>
  <th>[% text('Report Generated By:') %]</th>
  <td>[% entered_username %]</td>
</tr>
</table>

[% IF ! approved and !submitted%]
<fieldset id="csv-file">
  <div>
    <label for="file_upload">[% text('Bank transactions upload:') %]</label>
    [% PROCESS input element_data = {
    type="file"
    name="csv_file"
    id="file_upload"
    } %]
  </div>
  <div>
    <label for="trx_format">[% text('Upload file format') %]</label>
        [% PROCESS select element_data = {
                    name="trx_format"
                    options=upload_formats
                    text_attr="name"
                    value_attr="name"
                    default_blank=1
    } %]
  </div>
</fieldset>
[% END %]


[% IF error %]
<div style="border-color:red; border-width:1px; border-style:solid; margin:3px;" >
    [% error %]
</div>
[% END %]
[% i = 1 %]
<table border=0 id="cleared-table">
    <tr class="listtop">
        <th colspan="10">[% INCLUDE input element_data = {
        type = "toggle"
        name = "b_cleared_table"
        label = text('Cleared Transactions')
        checked = b_cleared_table
        "data-dojo-type" = "lsmb/PublishToggleButton"
        "data-dojo-props" = "topic:'ui/reconciliation/report/b_cleared_table'"
        }
        %]</th>
    </tr>
    <tr class="listheading">
        <th class="header" rowspan="2" scope="rowgroup"></th>
        <th class="header" rowspan="2" scope="rowgroup">
            [% text('Transaction Type') %]
        </th>
        <th class="header" rowspan="2" scope="rowgroup"
                id="cleared_header_column">
            [% text('Cleared') %]
            [% INCLUDE tooltip element_data = {
                    id => 'cleared_header_column',
                    position => ["above", "below", "after", "before"],
                    msg => text("Date when the transaction was cleared at your bank") };
            %]
        </th>
        <th class="header" rowspan="2" scope="rowgroup">
            [% text('Source') %]
        </th>
        <th class="header" rowspan="2" scope="rowgroup"
                id="posted_header_column">
            [% text('Posted') %]
            [% INCLUDE tooltip element_data = {
                    id => 'posted_header_column',
                    position => ["above", "below", "after", "before"],
                    msg => text("Date when the transaction was posted in the ledger") };
            %]
        </th>
        <th class="header" rowspan="2" scope="rowgroup">
            [% text('Description') %]
        </th>
        <th class="header" colspan="2" id="books_header_column">
            [% text('Books') %]
            [% INCLUDE tooltip element_data = {
                id => 'books_header_column',
                position => ["above", "below", "after", "before"],
                msg => text("Data from your ledger") };
            %]
        </th>
        <th class="header" colspan="2" id="bank_header_column">
            [% text('Bank') %]
            [% INCLUDE tooltip element_data = {
                id => 'bank_header_column',
                position => ["above", "below", "after", "before"],
                msg => text("Data from your bank statement") };
            %]
        </th>
    </tr>
    <tr class="listheading">
        <th class="header">[% text('Debits') %]</th>
        <th class="header">[% text('Credits') %]</th>
        <th class="header">[% text('Debits') %]</th>
        <th class="header">[% text('Credits') %]</th>
    </tr>

    [% FOREACH row = report_lines %]
            [% IF row.cleared -%]
                           [% row.cleared = 'checked' -%]
            [% ELSE %] [% row.cleared = undef -%]
            [% END -%]
    [% IF row.cleared == 'checked' %]
        [% INCLUDE input element_data = {
            type = "hidden",
            name = "id_$i",
            value = row.id
        } %]
        <tr class=[% row.suspect ? "suspect" : "record"%]>
            <td class="check">[% IF !approved and !submitted;
            INCLUDE input element_data = {
            type = "checkbox"
            name = "cleared_$row.id"
            value = row.id
            checked = row.cleared
            };
            END %]</td>
            <td>[% row.trans_type %] </td>
            [% id=''; class=''; element_data = {};
                IF row.days;
                    id="cleared_time_$row.id";
                    IF row.days < 0;
                        class='cleared-future';
                        element_data = {
                            id = id
                            msg = text('Clear date is [*,_1,day] in the future of after posting',0-row.days)
                        };
                    ELSIF row.days > 150;
                        class='cleared-past';
                        element_data = {
                            id = id
                            msg = text('Clear date over [*,_1,day]',row.days)
                        };
                    END;
                END;
            %]
            <td id='[% id %]' class='date [% class %]'>
                [% INCLUDE tooltip element_data; %]
            [% row.clear_time %]</td>
            <td>[% row.scn %] </td>
            <td class="date">[% row.post_date %]</td>
            <td>[% row.payee %]</td>
            <td class="money">[% reverse ? row.our_credits   : row.our_debits %]</td>
            <td class="money">[% reverse ? row.our_debits    : row.our_credits %]</td>
            <td class="money">[% reverse ? row.their_credits : row.their_debits %]</td>
            <td class="money">[% reverse ? row.their_debits  : row.their_credits %]</td>
        </tr>
    [% i = i + 1 -%]
    [% END %]
    [% END -%]
    <tr class="subtotal">
        <th colspan=6>[% text('Total') %]</th>
        <td class="money" id="total_cleared_debits">[% total_cleared_debits %]</td>
        <td class="money" id="total_cleared_credits">[% total_cleared_credits %]</td>
    </tr>
</table>

[%

have_mismatches = 0;
FOREACH row = report_lines ;
   IF row.err == 'mismatch' ;
      have_mismatches = 1;
      LAST;
   END;
END;

IF have_mismatches ; -%]
<table border=0 id="error-table">
    <tr class="listtop">
        <th colspan="10">[% INCLUDE input element_data = {
        type = "toggle"
        name = "b_mismatch_table"
        label = text('Mismatched Transactions (from upload)')
        checked = b_mismatch_table
        "data-dojo-type" = "lsmb/PublishToggleButton"
        "data-dojo-props" = "topic:'ui/reconciliation/report/b_mismatch_table'"
        }
        %]</th>
    </tr>
    <tr class="listheading">
        <th class="header"></th>
        <th class="header">[% text('Transaction Type') %]</th>
        <th class="header">[% text('Cleared') %]</th>
        <th class="header">[% text('Source') %]</th>
        <th class="header">[% text('Posted') %]</th>
        <th class="header">[% text('Description') %]</th>
        <th class="header">[% text('Our Debits') %]</th>
        <th class="header">[% text('Our Credits') %]</th>
        <th class="header">[% text('Their Debits') %]</th>
        <th class="header">[% text('Their Credits') %]</th>
    </tr>

    [% FOREACH row = report_lines %]
    [% IF row.err == 'mismatch' %]
    [% INCLUDE input element_data = {
        type = "hidden",
        name = "id_$i",
        value = row.id
    } %]
        <tr class=[% row.suspect ? "check suspect" : "check warning"%]>
            <td class="check">[% IF !approved and !submitted;
            INCLUDE input element_data = {
            type = "checkbox"
            name = "cleared_$row.id"
            value = row.id
            checked = row.cleared
            };
            END %]</td>
            <td>[% row.trans_type %]</td>
            <td class="date">[% row.clear_time %]</td>
            <td>[% row.scn %] </td>
            <td class="date">[% row.post_date %]</td>
            <td>[% row.payee %]</td>
            <td class="money">[% reverse ? row.our_credits   : row.our_debits %]</td>
            <td class="money">[% reverse ? row.our_debits    : row.our_credits %]</td>
            <td class="money">[% reverse ? row.their_credits : row.their_debits %]</td>
            <td class="money">[% reverse ? row.their_debits  : row.their_credits %]</td>
        </tr>
    [% i = i + 1 -%]
    [% END -%]
    [% END -%]
    <tr class="subtotal">
        <th colspan=6>[% text('Total') %]</th>
        <td class="money" id="total_mismatch_our_debits">[% mismatch_our_debits %]</td>
        <td class="money" id="total_mismatch_our_credits">[% mismatch_our_credits %]</td>
        <td class="money" id="total_mismatch_their_debits">[% mismatch_their_debits %]</td>
        <td class="money" id="total_mismatch_their_credits">[% mismatch_their_credits %]</td>
    </tr>
    </table>
[% END; # have_mismatches

have_outstanding = 0;
FOREACH row = report_lines ;
    IF row.cleared != 'checked' and row.err != 'mismatch';
      have_outstanding = 1;
      LAST;
    END;
END;


IF have_outstanding ;
-%]
<table id="outstanding-table">
    <tr class="listtop">
        <th colspan="6">[% INCLUDE input element_data = {
        type = "toggle"
        name = "b_outstanding_table"
        label = text('Outstanding Transactions')
        checked = b_outstanding_table
        "data-dojo-type" = "lsmb/PublishToggleButton"
        "data-dojo-props" = "topic:'ui/reconciliation/report/b_outstanding_table'"
        }
        %]</th>
    </tr>
    <tr class="listheading">
        <th class="header">[% text('Cleared') %]</th>
        <th class="header">[% text('Source') %]</th>
        <th class="header">[% text('Posted') %]</th>
        <th class="header">[% text('Description') %]</th>
        <th class="header">[% text('Our Debits') %]</th>
        <th class="header">[% text('Our Credits') %]</th>

    </tr>
    [%
    FOREACH row = report_lines;
        IF row.cleared != 'checked' and row.err != 'mismatch';
            INCLUDE input element_data = {
        type = "hidden",
        name = "id_$i",
        value = row.id
    } %]
        <tr class=[% row.suspect ? "suspect" : "record"%] id=[% "recon-line-$row.id" %]
            data-dojo-type = "lsmb/ReconciliationLine"
                data-dojo-props = "topic:'ui/reconciliation/report/cleared_[% row.id %]'">
                <td>
                [% IF !approved and !submitted;
            INCLUDE input element_data = {
            type = "checkbox"
            name = "cleared_$row.id"
            value = row.id
            checked = row.cleared
            "data-dojo-type" = "lsmb/PublishCheckBox"
                        "data-dojo-props" = "topic:'ui/reconciliation/report/cleared_" _ row.id _ "'"
            };
                    END %]
                </td>
            <td>[% row.scn %] </td>
                <td class="date">[% row.post_date %]</td>
            <td>[% row.payee %]</td>
                <td class="money">[% reverse ? row.our_credits   : row.our_debits %]</td>
                <td class="money">[% reverse ? row.our_debits    : row.our_credits %]</td>
        </tr>
            [% i = i + 1;
        END;
    END -%]
    <tr class="subtotal">
        <th colspan=4>[% text('Total') %]</th>
        <td class="money" id="total_outstanding_debits">[% total_uncleared_debits %]</td>
        <td class="money" id="total_outstanding_credits">[% total_uncleared_credits %]</td>
    </tr>
</table>
[% END; # have_outstanding %]
[% INCLUDE input element_data = {
    name = "end_date",
    type = "hidden",
    value = end_date,
} %]
[% INCLUDE input element_data = {
    name = "form_id",
    type = "hidden",
    value = form_id,
} %]
[% INCLUDE input element_data = {
    name = "report_id",
    type = "hidden",
    value = report_id,
} %]
[% IF NOT submitted %]
[% INCLUDE select element_data = {
    name = "line_order",
    label = text('Order By'), #'
    options = sort_options,
    text_attr = 'label',
    value_attr = 'id',
    default_values = [line_order]
    class = 'sort'
} %]
[% INCLUDE button element_data = {
    name = "__action",
    text = text('Update'),
    value = 'update_recon_set',
    class = "submit"
} %]
[% INCLUDE button element_data = {
        name = "__action"
        text = text('Select All') #'
       value = 'select_all_recons'
       class = 'submit'
} %]
[% INCLUDE button element_data = {
    name = "__action",
    text = text('Save'),
    value = 'save_recon_set',
    class = "submit"
'data-lsmb-doing' = text('Saving...')
'data-lsmb-done' = text('Saved')
} %]
[% INCLUDE button element_data = {
    name = "__action",
    text = text('Submit'),
    value = 'submit_recon_set',
    disabled = submit_enabled && !check.unapproved_reports ? 'false' : 'true',
    class = "submit"
} %]
[% END %]
[% IF submitted AND NOT approved AND can_approve %]
[% INCLUDE button element_data = {
    name = "__action",
    text = text('Approve'),
    value = 'approve',
    disabled = submit_enabled ? 'false' : 'true',
    class = "submit"
'data-lsmb-doing' = text('Approving...')
'data-lsmb-done' = text('Approved')
};
INCLUDE button element_data = {
    name = "__action",
    text = text('Reject'),
    value = 'reject',
    class = "submit"
'data-lsmb-doing' = text('Rejecting...')
'data-lsmb-done' = text('Rejected')
} %]
[% END %]
[% IF NOT approved %]
[% INCLUDE button element_data = {
        name = "__action"
        text = text('Delete')
       value = 'delete_report'
        type = 'submit'
       class = 'submit'
'data-lsmb-doing' = text('Deleting...')
'data-lsmb-done' = text('Deleted')
} %]
[% END %]
</form>
[%
   PROCESS attachments attachments={
     ref_key=report_id
     file_class=9
     files=files
     file_links=file_links
     callback='recon.pl?__action=display_report&report_id=' _ report_id
};
-%]
</div>
</body>
